/* jQuery Bracket | Copyright (c) Teijo Laine 2011-2014 | Licenced under the MIT licence */
(function(a){function b(a){return!isNaN(parseFloat(a))&&isFinite(a)}function c(a){function b(a,c){if(a instanceof Array)return b(a[0],c+1);return c}return b(a,0)}function d(a,b){if(b>0)a=d([a],b-1);return a}function e(){return{source:null,name:null,id:-1,idx:-1,score:null}}function f(a){if(b(a.a.score)&&b(a.b.score)){if(a.a.score>a.b.score)return[a.a,a.b];else if(a.a.score<a.b.score)return[a.b,a.a]}return[]}function g(a){return f(a)[0]||e()}function h(a){return f(a)[1]||e()}function i(b,c,d){var e=d.find(".team[data-teamid="+b+"]");var f;if(!c)f="highlight";else f=c;return{highlight:function(){e.each(function(){a(this).addClass(f);if(a(this).hasClass("win"))a(this).parent().find(".connector").addClass(f)})},deHighlight:function(){e.each(function(){a(this).removeClass(f);a(this).parent().find(".connector").removeClass(f)})}}}function j(b,c,d){var e=d||c;var f=e.winner();var g=e.loser();var h=null;var j=null;if(f&&g){h=i(f.idx,"highlightWinner",b);j=i(g.idx,"highlightLoser",b);h.highlight();j.highlight()}b.find(".team").mouseover(function(){var c=a(this).attr("data-teamid");var d=i(c,null,b);d.highlight();a(this).mouseout(function(){d.deHighlight();a(this).unbind("mouseout")})})}function k(b,c,d){var e=a('<input type="text">');e.val(c);b.html(e);e.focus();e.blur(function(){d(e.val())});e.keydown(function(a){var b=a.keyCode||a.which;if(b===9||b===13||b===27){a.preventDefault();d(e.val(),b!==27)}})}function l(a,b){a.append(b)}function m(a){var b=a.el;var c=b.find(".team.win");c.append('<div class="bubble">1st</div>');var d=b.find(".team.lose");d.append('<div class="bubble">2nd</div>');return true}function n(a){var b=a.el;var c=b.find(".team.win");c.append('<div class="bubble third">3rd</div>');var d=b.find(".team.lose");d.append('<div class="bubble fourth">4th</div>');return true}function o(a,b,c,d){var e=Math.log(b.length*2)/Math.log(2);var f=b.length;var g;for(var h=0;h<e;h+=1){g=a.addRound();for(var i=0;i<f;i+=1){var j=null;if(h===0){j=function(){var a=b[i];var c=i;return[{source:function(){return{name:a[0],idx:c*2}}},{source:function(){return{name:a[1],idx:c*2+1}}}]}}if(!(h===e-1&&c)){g.addMatch(j)}else{var k=g.addMatch(j,m);k.setAlignCb(function(a){a.css("top","");a.css("position","absolute");if(d)a.css("top",k.el.height()/2-a.height()/2+"px");else a.css("bottom",-a.height()/2+"px")})}}f/=2}if(c){a.final().connectorCb(function(){return null});if(b.length>1&&!d){var l=a.final().round().prev().match(0).loser;var o=a.final().round().prev().match(1).loser;var p=g.addMatch(function(){return[{source:l},{source:o}]},n);p.setAlignCb(function(b){var c=a.el.height()/2;p.el.css("height",c+"px");var d=b.height();b.css("top",d+"px")});p.connectorCb(function(){return null})}}}function p(a,b,c){var d=Math.log(c*2)/Math.log(2)-1;var e=c/2;for(var f=0;f<d;f+=1){for(var g=0;g<2;g+=1){var h=b.addRound();for(var i=0;i<e;i+=1){var j=null;if(!(g%2===0&&f!==0)){j=function(){if(g%2===0&&f===0){return[{source:a.round(0).match(i*2).loser},{source:a.round(0).match(i*2+1).loser}]}else{var c=i;if(f%2===0)c=e-i-1;return[{source:b.round(f*2).match(i).winner},{source:a.round(f+1).match(c).loser}]}}}var k=h.addMatch(j);var l=k.el.find(".teamContainer");k.setAlignCb(function(){l.css("top",k.el.height()/2-l.height()/2+"px")});if(f<d-1||g<1){var m=null;if(g%2===0){m=function(a,b){var c=a.height()/4;var d=0;var e=0;if(b.winner().id===0){e=c}else if(b.winner().id===1){d=-c*2;e=c}else{e=c*2}return{height:d,shift:e}}}k.connectorCb(m)}}}e/=2}}function q(a,b,c,d,e,f){var g=a.addRound();var h=g.addMatch(function(){return[{source:b.winner},{source:c.winner}]},function(e){var g=false;if(!d&&(e.winner().name!==null&&e.winner().name===c.winner().name)){if(a.size()===2)return;var h=a.addRound(function(){var b=e.winner().name!==null&&e.winner().name===c.winner().name;if(g===false){if(b){g=true;f.css("width",parseInt(f.css("width"),10)+140+"px")}}if(!b&&g){g=false;a.dropRound();f.css("width",parseInt(f.css("width"),10)-140+"px")}return b});var i=h.addMatch(function(){return[{source:e.first},{source:e.second}]},m);e.connectorCb(function(a){return{height:0,shift:a.height()/2}});i.connectorCb(function(){return null});i.setAlignCb(function(a){var d=b.el.height()+c.el.height();i.el.css("height",d+"px");var e=(b.el.height()/2+b.el.height()+c.el.height()/2)/2-a.height();a.css("top",e+"px")});return false}else{return m(e)}});h.setAlignCb(function(a){var d=b.el.height()+c.el.height();if(!e)d/=2;h.el.css("height",d+"px");var f=(b.el.height()/2+b.el.height()+c.el.height()/2)/2-a.height();a.css("top",f+"px")});var i;var j;if(!e){var k=c.final().round().prev().match(0).loser;var l=g.addMatch(function(){return[{source:k},{source:c.loser}]},n);l.setAlignCb(function(a){var d=(b.el.height()+c.el.height())/2;l.el.css("height",d+"px");var e=(b.el.height()/2+b.el.height()+c.el.height()/2)/2+a.height()/2-d;a.css("top",e+"px")});h.connectorCb(function(){return null});l.connectorCb(function(){return null})}b.final().connectorCb(function(a){var d=a.height()/4;var e=(b.el.height()/2+b.el.height()+c.el.height()/2)/2-a.height()/2;var f=e-b.el.height()/2;if(b.winner().id===0){j=f+d*2;i=d}else if(b.winner().id===1){j=f;i=d*3}else{j=f+d;i=d*2}j-=a.height()/2;return{height:j,shift:i}});c.final().connectorCb(function(a){var d=a.height()/4;var e=(b.el.height()/2+b.el.height()+c.el.height()/2)/2-a.height()/2;var f=e-b.el.height()/2;if(c.winner().id===0){j=f;i=d*3}else if(c.winner().id===1){j=f+d*2;i=d}else{j=f+d;i=d*2}j+=a.height()/2;return{height:-j,shift:-i}})}function r(b,c,d,e,f,g){var h=[];var i=a('<div class="round"></div>');return{el:i,bracket:b,id:d,addMatch:function(a,c){var f=h.length;var i;if(a!==null)i=a();else i=[{source:b.round(d-1).match(f*2).winner},{source:b.round(d-1).match(f*2+1).winner}];var j=g(this,i,f,!e?null:e[f],c);h.push(j);return j},match:function(a){return h[a]},prev:function(){return c},size:function(){return h.length},render:function(){i.empty();if(typeof f==="function")if(!f())return;i.appendTo(b.el);a.each(h,function(a,b){b.render()})},results:function(){var b=[];a.each(h,function(a,c){b.push(c.results())});return b}}}function s(b,c,d){var e=[];return{el:b,addRound:function(a){var b=e.length;var f=null;if(b>0)f=e[b-1];var g=r(this,f,b,!c?null:c[b],a,d);e.push(g);return g},dropRound:function(){e.pop()},round:function(a){return e[a]},size:function(){return e.length},"final":function(){return e[e.length-1].match(0)},winner:function(){return e[e.length-1].match(0).winner()},loser:function(){return e[e.length-1].match(0).loser()},render:function(){b.empty();for(var a=0;a<e.length;a+=1)e[a].render()},results:function(){var b=[];a.each(e,function(a,c){b.push(c.results())});return b}}}function t(b,c,d,e){var f=parseInt(a(".round:first").css("margin-right"),10)/2;var g=true;if(b<0){g=false;b=-b}if(b<2)b=0;var h=a('<div class="connector"></div>').appendTo(d);h.css("height",b);h.css("width",f+"px");h.css(e,-f-2+"px");if(c>=0)h.css("top",c+"px");else h.css("bottom",-c+"px");if(g)h.css("border-bottom","none");else h.css("border-top","none");var i=a('<div class="connector"></div>').appendTo(h);i.css("width",f+"px");i.css(e,-f+"px");if(g)i.css("bottom","0px");else i.css("top","0px");return h}function u(b,c,d){var e=a('<div class="tools"></div>').appendTo(b);var f=a('<span class="increment">+</span>').appendTo(e);f.click(function(){var a;var b=c.teams.length;for(a=0;a<b;a+=1)c.teams.push(["",""]);return v(d)});if(c.teams.length>1&&c.results.length===1||c.teams.length>2&&c.results.length===3){var g=a('<span class="decrement">-</span>').appendTo(e);g.click(function(){if(c.teams.length>1){c.teams=c.teams.slice(0,c.teams.length/2);return v(d)}})}var h;if(c.results.length===1&&c.teams.length>1){h=a('<span class="doubleElimination">de</span>').appendTo(e);h.click(function(){if(c.teams.length>1&&c.results.length<3){c.results.push([],[]);return v(d)}})}else if(c.results.length===3&&c.teams.length>1){h=a('<span class="singleElimination">se</span>').appendTo(e);h.click(function(){if(c.results.length===3){c.results=c.results.slice(0,1);return v(d)}})}}var v=function(e){var f=e.dir==="lr"?"right":"left";var i;if(!e)throw Error("Options not set");if(!e.el)throw Error("Invalid jQuery object as container");if(!e.init&&!e.save)throw Error("No bracket data or save callback given");if(e.userData===undefined)e.userData=null;if(e.decorator&&(!e.decorator.edit||!e.decorator.render))throw Error("Invalid decorator input");else if(!e.decorator)e.decorator={edit:k,render:l};var m;if(!e.init)e.init={teams:[["",""]],results:[]};m=e.init;var n=a('<div class="jQBracket '+e.dir+'"></div>').appendTo(e.el.empty());function r(a){i=0;x.render();if(y&&z){y.render();z.render()}j(n,x,z);if(a){m.results[0]=x.results();if(y&&z){m.results[1]=y.results();m.results[2]=z.results()}if(e.save)e.save(m,e.userData)}}function v(c,d,j,k,l){var m={a:d[0],b:d[1]};function o(c,d,f){var j=i;var k=a('<div class="score" data-resultid="result-'+j+'"></div>');var l;if(!d.name||!f){l="--"}else{if(!b(d.score)){l="--"}else{l=d.score}}k.append(l);i+=1;var o=!d.name?"--":d.name;var p=a('<div class="team"></div>');var q=a('<div class="label"></div>').appendTo(p);if(c===0)p.attr("data-resultid","team-"+j);e.decorator.render(q,o,l);if(b(d.idx))p.attr("data-teamid",d.idx);if(d.name===null)p.addClass("na");else if(g(m).name===d.name)p.addClass("win");else if(h(m).name===d.name)p.addClass("lose");p.append(k);if(!(d.name===null||!f||!e.save)&&e.save){q.addClass("editable");q.click(function(){var b=a(this);function f(){function g(g,h){if(g)e.init.teams[~~(d.idx/2)][d.idx%2]=g;r(true);b.click(f);var i=e.el.find(".team[data-teamid="+(d.idx+1)+"] div.label:first");if(i.length&&h===true&&c===0)a(i).click()}b.unbind();e.decorator.edit(b,d.name,g)}f()});if(d.name){k.addClass("editable");k.click(function(){var c=a(this);function e(){c.unbind();var f;if(!b(d.score))f="0";else f=c.text();var g=a('<input type="text">');g.val(f);c.html(g);g.focus().select();g.keydown(function(c){if(!b(a(this).val()))a(this).addClass("error");else a(this).removeClass("error");var d=c.keyCode||c.which;if(d===9||d===13||d===27){c.preventDefault();a(this).blur();if(d===27)return;var e=n.find("div.score[data-resultid=result-"+(j+1)+"]");if(e)e.click()}});g.blur(function(){var a=g.val();if((!a||!b(a))&&!b(d.score))a="0";else if((!a||!b(a))&&b(d.score))a=d.score;c.html(a);if(b(a)&&f!==parseInt(a,10)){d.score=parseInt(a,10);r(true)}c.click(e)})}e()})}}return p}var p=null;var q=null;var s=a('<div class="match"></div>');var u=a('<div class="teamContainer"></div>');if(!e.save){var v=k?k[2]:null;if(e.onMatchHover)u.hover(function(){e.onMatchHover(v,true)},function(){e.onMatchHover(v,false)});if(e.onMatchClick)u.click(function(){e.onMatchClick(v)})}m.a.id=0;m.b.id=1;m.a.name=m.a.source().name;m.b.name=m.b.source().name;m.a.score=!k?null:k[0];m.b.score=!k?null:k[1];if((!m.a.name||!m.b.name)&&(b(m.a.score)||b(m.b.score))){console.log("ERROR IN SCORE DATA: "+m.a.source().name+": "+m.a.score+", "+m.b.source().name+": "+m.b.score);m.a.score=m.b.score=null}return{el:s,id:j,round:function(){return c},connectorCb:function(a){p=a},connect:function(a){var b=u.height()/4;var c=s.height()/2;var d;var e;if(!a||a===null){if(j%2===0){if(this.winner().id===0){d=b;e=c}else if(this.winner().id===1){d=b*3;e=c-b*2}else{d=b*2;e=c-b}}else{if(this.winner().id===0){d=-b*3;e=-c+b*2}else if(this.winner().id===1){d=-b;e=-c}else{d=-b*2;e=-c+b}}}else{var g=a(u,this);if(g===null)return;d=g.shift;e=g.height}u.append(t(e,d,u,f))},winner:function(){return g(m)},loser:function(){return h(m)},first:function(){return m.a},second:function(){return m.b},setAlignCb:function(a){q=a},render:function(){s.empty();u.empty();m.a.name=m.a.source().name;m.b.name=m.b.source().name;m.a.idx=m.a.source().idx;m.b.idx=m.b.source().idx;var a=false;if((m.a.name||m.a.name==="")&&(m.b.name||m.b.name===""))a=true;if(!g(m).name)u.addClass("np");else u.removeClass("np");u.append(o(c.id,m.a,a));u.append(o(c.id,m.b,a));s.appendTo(c.el);s.append(u);this.el.css("height",c.bracket.el.height()/c.size()+"px");u.css("top",this.el.height()/2-u.height()/2+"px");if(q)q(u);var b=false;if(typeof l==="function")b=l(this);if(!b)this.connect(p)},results:function(){return[m.a.score,m.b.score]}}}function w(c){var d=c.teams;var e=c.results;if(!d){console.log("no teams",c);return false}if(!e)return true;if(d.length<e[0][0].length){console.log("more results than teams",c);return false}for(var f=0;f<e.length;f+=1){for(var g=0;g<~~(e[f].length/2);g+=1){if(e[f][2*g].length<e[f][2*g+1].length){console.log("previous round has less scores than next one",c);return false}}}for(var g=0;g<e[0].length;g+=1){if(!e[1]||!e[1][g*2])break;if(e[0][g].length<=e[1][g*2].length){console.log("lb has more results than wb",c);return false}}try{a.each(e,function(c,d){a.each(d,function(c,d){a.each(d,function(a,c){if(c.length!==2){console.log("match size not valid",c);throw"match size not valid"}if(!(b(c[0])?b(c[1]):!b(c[1]))){console.log("mixed results",c);throw"mixed results"}})})})}catch(h){console.log(h);return false}return true}var x,y,z;var A=m.results;A=d(A,4-c(A));m.results=A;var B=A.length<=1;if(e.skipSecondaryFinal&&B)a.error("skipSecondaryFinal setting is viable only in double elimination mode");if(e.save)u(n,m,e);var C,D,E;if(B){D=a('<div class="bracket"></div>').appendTo(n)}else{C=a('<div class="finals"></div>').appendTo(n);D=a('<div class="bracket"></div>').appendTo(n);E=a('<div class="loserBracket"></div>').appendTo(n)}var F=m.teams.length*64;D.css("height",F);if(B&&m.teams.length<=2&&!e.skipConsolationRound){F+=40;n.css("height",F)}if(E)E.css("height",D.height()/2);var G;if(B)G=Math.log(m.teams.length*2)/Math.log(2);else G=(Math.log(m.teams.length*2)/Math.log(2)-1)*2+1;if(e.save)n.css("width",G*140+40);else n.css("width",G*140+10);x=s(D,!A||!A[0]?null:A[0],v);if(!B){y=s(E,!A||!A[1]?null:A[1],v);z=s(C,!A||!A[2]?null:A[2],v)}o(x,m.teams,B,e.skipConsolationRound);if(!B){p(x,y,m.teams.length);q(z,x,y,e.skipSecondaryFinal,e.skipConsolationRound,n)}r(false);return{data:function(){return e.init}}};var w={init:function(b){var c=this;b.el=this;if(b.save&&(b.onMatchClick||b.onMatchHover))a.error("Match callbacks may not be passed in edit mode (in conjunction with save callback)");b.dir=b.dir||"lr";b.init.teams=!b.init.teams||b.init.teams.length==0?[["",""]]:b.init.teams;b.skipConsolationRound=b.skipConsolationRound||false;b.skipSecondaryFinal=b.skipSecondaryFinal||false;if(b.dir!=="lr"&&b.dir!=="rl")a.error('Direction must be either: "lr" or "rl"');var d=v(b);a(this).data("bracket",{target:c,obj:d});return d},data:function(){var b=a(this).data("bracket");return b.obj.data()}};a.fn.bracket=function(b){if(w[b]){return w[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return w.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.bracket")}}})(jQuery);